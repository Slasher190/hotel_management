// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
}

enum BookingStatus {
  ACTIVE
  CHECKED_OUT
}

enum PaymentMode {
  CASH
  ONLINE
}

enum PaymentStatus {
  PAID
  PENDING
}

enum IdType {
  AADHAAR
  DL
  VOTER_ID
  PASSPORT
  OTHER
}

enum BusStatus {
  BOOKED
  PENDING
}

enum UserRole {
  MANAGER
  STAFF
  CHEF
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(MANAGER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expenses Expense[]

  @@map("users")
}

model SystemSettings {
  id                  String   @id @default(cuid())
  passwordResetSecret String   @default("HOTEL_RESET_2024") // Default secret for password reset
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("system_settings")
}

// Update existing enum
enum RoomCategory {
  ROOM
  HALL
}

model RoomType {
  id        String       @id @default(cuid())
  name      String       @unique
  price     Float        @default(0)
  category  RoomCategory @default(ROOM)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  rooms Room[]

  @@map("room_types")
}

model Room {
  id         String     @id @default(cuid())
  roomNumber String     @unique
  roomTypeId String
  roomType   RoomType   @relation(fields: [roomTypeId], references: [id], onDelete: Restrict)
  status     RoomStatus @default(AVAILABLE)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  bookings Booking[]

  @@map("rooms")
}

model Booking {
  id                        String  @id @default(cuid())
  visitorRegistrationNumber Int?    @unique @default(autoincrement())
  roomId                    String
  room                      Room    @relation(fields: [roomId], references: [id], onDelete: Cascade)
  guestName                 String
  guestAddress              String?
  guestMobile               String?
  guestGstNumber            String?

  companyName String?
  department  String?
  designation String?

  purpose    String?
  billNumber String?
  billDate   DateTime?

  idType   IdType
  idNumber String?

  adults                 Int   @default(1)
  children               Int   @default(0)
  additionalGuests       Int   @default(0)
  additionalGuestCharges Float @default(0) // Extra charges per additional guest
  mattresses             Int   @default(0)

  roomPrice    Float
  discount     Float         @default(0)
  tariff       Float? // Additional tariff charges
  status       BookingStatus @default(ACTIVE)
  checkInDate  DateTime      @default(now())
  checkoutDate DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  foodOrders FoodOrder[]
  invoices   Invoice[]
  payments   Payment[]

  @@map("bookings")
}

model FoodItem {
  id         String   @id @default(cuid())
  name       String
  category   String
  price      Float
  gstPercent Float    @default(0)
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  foodOrders FoodOrder[]

  @@map("food_items")
}

model FoodOrder {
  id         String   @id @default(cuid())
  bookingId  String
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  foodItemId String
  foodItem   FoodItem @relation(fields: [foodItemId], references: [id])
  quantity   Int
  invoiceId  String? // Track which invoice this order belongs to (null = not invoiced)
  invoice    Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  createdAt  DateTime @default(now())

  @@map("food_orders")
}

model Invoice {
  id                        String      @id @default(cuid())
  bookingId                 String? // Nullable - allows independent manual bills
  booking                   Booking?    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  invoiceNumber             String      @unique
  visitorRegistrationNumber String? // Auto-generated visitor register serial number
  billNumber                String? // Manual input bill number
  invoiceType               String // "ROOM" or "FOOD"
  isManual                  Boolean     @default(false) // true for manually generated bills
  guestName                 String
  guestAddress              String?
  guestState                String?
  guestNationality          String?
  guestGstNumber            String?
  guestStateCode            String?
  guestMobile               String?
  idType                    String? // ID type (Aadhaar, DL, etc.)
  idNumber                  String? // ID number
  companyName               String?
  companyCode               String?
  department                String? // Company department
  designation               String? // Job designation
  businessPhoneNumber       String? // Business phone
  roomNumber                String? // Room number (auto-filled)
  roomType                  String?
  particulars               String? // Selection from rooms
  rentPerDay                Float? // Manual input rent per day
  numberOfDays              Int         @default(1) // Manual input, default 1
  checkInDate               DateTime? // Check-in date
  checkOutDate              DateTime? // Check-out date
  adults                    Int         @default(1) // Adult count, default 1
  children                  Int         @default(0) // Children count, default 0
  totalGuests               Int         @default(1) // Calculated: adults + children
  roomCharges               Float       @default(0)
  foodCharges               Float       @default(0)
  tariff                    Float       @default(0) // Additional tariff
  additionalGuestCharges    Float       @default(0) // Charges for additional guests
  discount                  Float       @default(0) // Discount amount
  gstEnabled                Boolean     @default(false)
  gstNumber                 String?
  gstAmount                 Float       @default(0)
  advanceAmount             Float       @default(0)
  roundOff                  Float       @default(0)
  totalAmount               Float
  pdfPath                   String?
  billDate                  DateTime? // For backdated bills
  purpose                   String? // Purpose of stay
  createdAt                 DateTime    @default(now())
  foodOrders                FoodOrder[] // Food orders included in this invoice

  @@map("invoices")
}

model Payment {
  id        String        @id @default(cuid())
  bookingId String
  booking   Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  mode      PaymentMode
  status    PaymentStatus @default(PENDING)
  amount    Float
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("payments")
}

model HotelSettings {
  id        String   @id @default(cuid())
  name      String
  address   String
  phone     String
  email     String?
  gstin     String?
  logoUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hotel_settings")
}

model BusBooking {
  id        String    @id @default(cuid())
  busNumber String
  fromDate  DateTime
  toDate    DateTime
  status    BusStatus @default(PENDING)
  notes     String?
  bookingAmount Float    @default(0)
  advanceAmount Float    @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("bus_bookings")
}

model Expense {
  id          String   @id @default(cuid())
  staffId     String
  recipient   String   // "To" person/entity
  description String
  amount      Float
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [staffId], references: [id])

  @@map("expenses")
}
